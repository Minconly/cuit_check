<layuicss/>
<link rel="stylesheet" href="__PUBLIC__/student/SemanticUI/semantic.min.css">



<style>

    legend{
        text-align: center;
    }
    .container{
        display:flex;
        width:100%;
        align-item:stretch;
        padding-top: 10px;
    }
    .left{
        min-width:35%;
        padding-left: 250px;
    }
    .right{
        width:100%;
        padding-right: 250px;
    }
    .msg-box{
        padding-left: 250px;
        padding-right: 250px;
    }
    .body-main{
        padding-top: 20px;
    }
    .man-box{
        padding-left:20px;
        padding-top: 18px;
    }
    /*.image img{*/
        /*width: 5px;*/
        /*height: 5px;*/
    /*}*/
    /*.ui.card>.extra, .ui.cards>.card>.extra{*/
        /*padding: 0px;*/
        /*text-align: center;*/
        /*color: #0C0C0C;*/
    /*}*/
    /*.card{*/
        /*max-height: 80px !important;*/
        /*max-width: 60px !important;*/
        /*font-weight: lighter;*/
    /*}*/
    /*.ui.card{*/
        /*overflow:hidden !important;*/

    /*}*/
    .card{
        width: 77px !important;
        height: 97px !important;
    }
    .box{
        padding-left: 5px !important;
        padding-right: 8px !important;
        padding-top: 7px !important;
    }
    .gray {
        -webkit-filter: grayscale(1); /* Webkit */
        filter: gray; /* IE6-9 */
        filter: grayscale(1); /* W3C */
    }


    .send {
        position:relative;
        width:85%;
        height:35px;
        background: #9bb2ff;
        border-radius:5px; /* 圆角 */
       margin-top: 15px;
        margin-left: 16px;
    }

    .send .arrow {
        position:absolute;
        top:8px;
        left:-16px; /* 圆角的位置需要细心调试哦 */
        width:0;
        height:0;
        font-size:0;
        border:solid 8px;
        border-color: #ffffff  #9bb2ff #ffffff #ffffff;
    }
    .image img{
        width: 77px !important;
        height: 77px !important;
    }
    .online{
        color: #ff0027;
    }
    .offline {
        color: rgba(5, 11, 13, 0.97);
    }
</style>

<div class="body-main">
    <div class="sign-diver" >
        <h4 class="ui horizontal header divider">
            <i class="bar chart icon"></i>
            在线监控
        </h4>
    </div>
    <div class="container">
        <div class="left">
            <fieldset class="layui-elem-field" style="min-height: 570px;max-height: 570px">
                <legend>消息记录</legend>
                <div class="his-box">
                </div>
            </fieldset>
        </div>
        <div class="right">
            <fieldset class="layui-elem-field" style="min-height: 570px;max-height: 570px">
                <legend>在线状态</legend>
                <div class="man-box">
                    <div class="ui  grid">
                        <foreach name="user_list" item="v">
                            <div class="box" id="{$v.account}" data-id="{$v.account}">
                                <div class="ui fluid card">
                                    <div class="image">
                                        <img class="gray" src="__SITE__{$v.photo}">
                                    </div>
                                    <label>{$v.name}<i class="wifi icon offline"></i></label>
                                </div>
                            </div>
                        </foreach>
                </div>
            </fieldset>
        </div>
    </div>
    <div class="msg-box">
        <fieldset class="layui-elem-field" style="min-height: 20%;max-height: 20%">
            <legend>消息推送</legend>
        <div class="sec_who" style="padding-bottom: 15px;">
            <div class="ui input focus fluid">
                <div class="ui toggle checkbox" style="padding-left: 15px;padding-top: 7px;padding-right: 15px;">
                    <input type="checkbox" name="public" id="public" />
                    <label>全部</label>
                </div>
                <div class="ui basic buttons toUsers">

                </div>
            </div>
        </div>
        <div class="textarae">
            <textarea style="height: 15%;width: 100%;" id="msg"></textarea>
        </div>
        <button class="fluid ui button primary" id="sendMsg">发送消息</button>
        </fieldset>
    </div>
</div>
<script type="text/javascript" src="__PUBLIC__/worker/js/swfobject.js"></script>
<script type="text/javascript" src="__PUBLIC__/worker/js/web_socket.js"></script>
<script type="text/javascript" src="__PUBLIC__/worker/js/jquery.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/worker/js/jquery-sinaEmotion-2.1.0.min.js"></script>
<layuijs/>
<script type="text/javascript">
    $(function () {
        layui.use(['layer','upload'],function(){
            var layer = layui.layer;
            var toUser_list = [];
            connect();
            $('.box').on('click',function(){
                _this = $(this);
                var _toUsersDom = $('.toUsers');
                var client = _this.data('client');
                var uid = _this.data('id');
                if(client===undefined){
                    layer.alert("不能给不在线的用户发信息!");
                }else{
                    // 判断是否已经存在于接收数组中
                    //TODO
                    var flag = $.inArray(client,toUser_list);
                    console.log(flag);
                    if(flag>=0){
                        layer.alert("该学生已加入发送列表!");
                        return ;
                    }
                    toUser_list.push(client);
                    console.log(toUser_list);
                    var name= $('#'+uid+'>div>label').text();
                    var htmlStr = ' <div class="ui button">'+name+'</div>';
                    //追加发送用户
                    _toUsersDom.append(htmlStr);

                }
            });
            //发送全部
            $('#public').on('change', function () {
                $('.toUsers').html('');
                toUser_list.length = 0;
            });

            //发送消息
            $('#sendMsg').on('click', function(){
                var isall = $('input[name="public"]').is(":checked");
                var msg = $("#msg").val();
                if(msg==""){
                    layer.msg("发送内容不能为空!");
                    return ;
                }
                var params = {
                    type:'say',
                    to_client_id:'all',
                    content:  msg,
                };
                if(isall){
                    //给全部人发送
                    console.log("发送消息全部人");
                    var sen_data = JSON.stringify(params);
                    console.log(sen_data);
                    say(sen_data);
                }else{
                    //给队列中的人发送
                    console.log("发送消息给选中的人");
                    params['to_client_id'] =toUser_list;
                    var send_data = JSON.stringify(params);
                    console.log(send_data);
                    say(send_data);
                }
            });

        });
    });



    if (typeof console == "undefined") {    this.console = { log: function (msg) {  } };}
    // 如果浏览器不支持websocket，会使用这个flash自动模拟websocket协议，此过程对开发者透明
    WEB_SOCKET_SWF_LOCATION = "/swf/WebSocketMain.swf";
    // 开启flash的websocket debug
    WEB_SOCKET_DEBUG = true;
    var ws, name, client_list={};
    // 连接服务端
    function connect() {
        // 创建websocket
        ws = new WebSocket("ws://"+document.domain+":7272");
        // 当socket连接打开时，输入用户名
        ws.onopen = onopen;
        // 当有消息时根据消息类型显示不同信息
        ws.onmessage = onmessage;
        ws.onclose = function() {
            console.log("连接关闭，定时重连");
            connect();
        };

        ws.onerror = function() {
            console.log("出现错误");
        };
    }

    // 连接建立时发送登录信息
    function onopen()
    {
        console.log(ws);
        // 登录
        var params = {
            'client_name':"{$accountname}",
            'room_id':"{$room_id}",
            'account':"{$account}",
            'account_type':"{$account_type}",
            'type':"login",
        };
        var login_data = JSON.stringify(params);
        console.log("websocket握手成功，发送登录数据:"+login_data);
        ws.send(login_data);
    }

    // 服务端发来消息时
    function onmessage(e)
    {
        console.log(e.data);
        var data = JSON.parse(e.data);
        switch(data['type']){
            // 服务端ping客户端
            case 'ping':
                ws.send('{"type":"pong"}');
                break;;
            // 登录 更新用户列表
            case 'login':
                //{"type":"login","client_id":xxx,"client_name":"xxx","client_list":"[...]","time":"xxx"}

                //say(data['client_id'], data['client_name'],  data['client_name']+' 加入了聊天室', data['time']);
                flush_connect_user(data['client_name'],data['client_id'],'login');
                if(data['client_list'])
                {
                    client_list = data['client_list'];
                }
                else
                {
                    client_list[data['client_id']] = data['client_name'];
                }
                flush_client_list();
                console.log(data['client_name']+"登录成功");
                break;
            // 发言
            case 'say':
                //{"type":"say","from_client_id":xxx,"to_client_id":"all/client_id","content":"xxx","time":"xxx"}
                say(data['from_client_id'], data['from_client_name'], data['content'], data['time']);
                break;
            // 用户退出 更新用户列表
            case 'logout':
                //{"type":"logout","client_id":xxx,"time":"xxx"}
                say(data['from_client_id'], data['from_client_name'], data['from_client_name']+' 退出了', data['time']);
                delete client_list[data['from_client_id']];
                console.log(data['from_client_name']+"logout");
                //刷新在线状态
                flush_connect_user(data['from_client_name'],data['from_client_id'],'logout');
                flush_client_list();
        }
    }

    //有新的学生账号链接之后刷新该头像的状态
    function flush_connect_user(account,client_id,type){
        var _this = $('#'+account);
        var _index =  $('#'+account+'>div>div>img');
        var _label = $('#'+account+'>div>label>i');
        if(type==='login'){
            _this.attr('data-client',client_id);
            _index.removeClass('gray');
            _label.removeClass('offline').addClass('online');
        }else{
            _index.addClass('gray');
            _this.removeAttr('data-client');
            _label.removeClass('online').addClass('offline');
        }
    }

    // 刷新用户列表框
    function flush_client_list(){
        for(var p in client_list){
            var _index = $('#'+client_list[p]+'>div>div>img');
            var _label = $('#'+client_list[p]+'>div>label>i');
            var _this = $('#'+client_list[p]);
            _this.attr('data-client',p);
            _index.removeClass('gray');
            _label.removeClass('offline').addClass('online');
        }

    }

    // 发消息
    function say(params){
       ws.send(params);
    }


</script>